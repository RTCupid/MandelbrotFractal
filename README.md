# Работа 3.3.3.<br> Фрактал Мандельброта. Оптимизация времени расчёта точек и реализация графики при помощи библиотеки SFML

## Contents
- [0. Аннотация](#аннотация)
- [1. Введение](#введение)
- [2. Методика](#методика)
- [3. Результаты и их обсуждение](#результаты-и-их-обсуждение)
- [4. Выводы](#выводы)
- [5. Приложение](#приложение)

## Аннотация

Я написал две версии программы для расчёта точек во фрактале Мандельброта. В первой версии проводился обычный расчёт точек, во второй использовались интринсики для оптимизации времени расчёта. Оптимизация при помощи интринсиков дала ускорение в 6.26 раз.

## Введение

  В графике и компьютерных играх часто необходимо рассчитывать позиции и цвет для большого количества точек. Компилятору не всегда известно зависят ли между собой данные для расчёта разных точек, однако это необходимо для того, чтобы оптимизировать расчёты путём параллельного вычисления сразу нескольких точек. Поэтому важно явно показать независимость данных. Например, можно поместить несколько чисел в 256-битный регистр и использовать для расчёта специальные функции, которые называются интринсиками.

## Методика

  Для сравнения эффективности обычного метода с эффективностью расчёта с помощью интринсиков можно провести расчёт определённого количества точек обоими методами, измерить и сравнить время их выполнения. Для измерения времени можно использовать класс библиотеки SFML sf::Time. Важно учесть, что время выполнения программы может зависеть от состояния машины, на которой она выполняется, поэтому следует проводить измерения при одном и том же состоянии.

## Результаты и их обсуждение

### Модель

  В качестве теста для проверки эффективности расчёта при помощи интринсиков я использовал фрактал Мандельброта, потому что на его основе можно провести расчёт для большого числа точек, а также он имеет красивую графику (см. рис. 1) и является простым в реализации.

  <img src="img/Fractal.png">
  <div align="center"> Рис. 1.Моя графика для фрактала Мандельброта.Чёрным цветом показаны точки, которые принадлежат фракталу, фиолетовые - не принадлежат, и имеют разные оттенки в зависимости от того на каком шаге расчёта они выходят за границы круга некоторого радиуса с центром в точке 0 (особенностью фрактала является то, что точки, выходящие за его границы уходят на бесконечность, а точки лежащие внутри него всегда остаются внутри).</div><br>

  Также использовался аргумент командной строки "ntests", который показывал сколько раз провести расчёт всех точек перед очередным обновлением экрана, этот параметр позволял по желанию увеличивать время расчёта для повышения точности измерений. Если он не указан, то принимается ntests = 1.

  Некоторые красивые места моего фрактала приведены в Приложении В.

### Результаты измерений

  Я написал две версии программы для расчёта точек для фрактала Мандельброта. В первой версии производился обычный расчёт для каждой точки по отдельности. Однако я заметил, что с ключом оптимизации -О3 компилятор уже сгенерировал код, использующий xmm регистры, чтобы выполнить некоторые расчёты параллельно.
  
  Чтобы узнать, какое ускорение можно получить, написав собственную реализацию параллельных вычислений, я сделал вторую версию функции для расчёта точек фрактала Мандельброта, в которой использовал интринсики (см. Приложение A).
  
  Чтобы уменьшить случайную погрешность измерения времени, я увеличил время одного эксперимента в 120 раз, увеличив количество расчётов всех точек на экране за одно измерение с 1 до 120. Программа компилировалась с ключом оптимизации -О3. Измерения проводились в одно время при одинаковых состояниях системы. 
  
  Были проведены измерения времени для двух версий с разными ключами оптимизации (см. Приложение Б). Для лучшего визуального восприятия отобразил эти данные на графике (см. Рис. 2).

  <div align="center"><img src="/img/Measurings.png"></div>
  <div align="center"> Рис. 2. На графике изображены результаты измерений для двух версий программы: обычной и оптимизированной интринсиками. По оси y отложено время, затраченное на 120 итераций расчёта всех точек на экране, по оси х показан номер измерения. Красные точки показывают значения времени, полученные для обычной версии без ключей оптимизации. Зелёные - с ключом оптимизации -O3. Оранжевые точки отражают соответствующие значения в моей версии, с оптимизацией при помощи интринсиков, но без ключей оптимизации. Синие - второй версии с ключом оптимизации -О3. Измерения проводились в одно время и при одинаковых состояниях системы.</div><br>

  Для сравнения сделал скриншоты моей графики фрактала Мандельброта с отображением FPS (см. Рис. 2, 3). В версии с интринсиками FPS в разы выше, чем в обычной версии.

  <img src="img/FPSCommon.png">
  <div align="center"> Рис. 3. Обычная версия расчёта точек для фрактала Мандельброта. Компилировалась без ключей оптимизации. FPS измерялся в релизной версии с параметром ntests = 1.</div><br>

   <img src="img/FPSIntrinsics.png">
  <div align="center"> Рис. 4. Версия расчёта точек для фрактала Мандельброта с оптимизацией интринсиками. Компилировалась с ключом оптимизации -O3. FPS измерялся в релизной версии с параметром ntests = 1.</div><br>

  Итоговые результаты измерений привёл в таблице 1.
  
  | Версия         | среднее время 120 расчётов всех точек экрана для фрактала Мандельброта, с ± 10<sup>-6</sup> | среднее время, с ± 10<sup>-6</sup> |  FPS        |
  |-----------------|-------------------------------------------------------|-----------------------------------|-------------|
  | Common          | 39.573971                                             | 0.329783                          |  3.032297   |
  | Common -O3      | 19.977071                                             | 0.166475                          |  6.006907   | 
  | Intrinsics      | 23.830571                                             | 0.198588                          |  5.035550   |
  | Intrinsics -O3  |  6.326352                                             | 0.052719                          | 18.968493   |

  FPS во второй версии, оптимизированной интринсиками получился в 6.26 раз выше, чем в первой версии.

## Выводы

Оптимизация интринсиками позволила ускорить работу программы в 6.26 раз. Это показывает, насколько эффективной может быть эта аппаратнозависимая оптимизация при работе с большим количеством независимых данных, над которыми производятся одинаковые вычисления. Несмотря на то, что с ключом -О3 компилятор оптимизировал программу, используя xmm регистры для векторизации вычислений, получилось путём использования интринсиков получить ускорение в 3.16 раз по сравнению с обычной версией, оптимизированной -О3. 

## Приложение

### Приложение А. Ход работы

  В качестве первого шага оптимизации я провёл развёртку цикла. Затем я заменил операции с несколькими точками на циклы и вынес эти циклы в inline функции для работы с массивами из четырёх чисел типа float. После я заменил мои функции для действий с массивами из четырёх чисел на интринсики, работающие с векторами типа __m128, в которые я поместил четыре точки для расчёта. В следующем блоке кода показан основной цикл расчёта точек для фрактала Мандельброта, оптимизированный при помощи интринсиков.

``` C++
while (true)
{
    __m128 squared_X = _mm_mul_ps (X, X);
    __m128 squared_Y = _mm_mul_ps (Y, Y);
    __m128       X_Y = _mm_mul_ps (X, Y);

    __m128 squared_r = _mm_add_ps (squared_X, squared_Y);

    cmp              = _mm_cmple_ps (squared_r, squared_r_max);

    int mask         = _mm_movemask_ps (cmp);

    if (!mask) break;

    X          = _mm_add_ps (_mm_sub_ps (squared_X, squared_Y), array_X0_dx_scale_index);

    Y          = _mm_add_ps (_mm_add_ps (X_Y, X_Y), array_Y0);

    cmp        = _mm_and_ps(cmp, _mm_set_ps1(1.0f));

    niteration = _mm_add_ps (niteration, cmp);

    cmp        = _mm_cmple_ps (niterationmax, niteration);

    mask       = _mm_movemask_ps (cmp);

    if (mask) break;
}
```

### Приложение Б. Экспериментальные данные
| №   | Время в обычной версии, с ± 10<sup>-6</sup>  | №   | Время в обычной времени, с ± 10<sup>-6</sup>    |
|-----|------------|-----|------------|
| 1   | 39.586754  | 14  | 39.550  |
| 2   | 39.535309  | 15  | 39.498  |
| 3   | 39.734772  | 16  | 39.936  |
| 4   | 39.546391  | 17  | 39.886  |
| 5   | 39.525013  | 18  | 39.925  |
| 6   | 39.608234  | 19  | 39.496  |
| 7   | 39.636932  | 20  | 39.608  |
| 8   | 39.844189  | 21  | 39.929  |
| 9   | 39.729008  | 22  | 39.544  |
| 10  | 39.813049  | 23  | 39.657  |
| 11  | 39.504421  | 24  | 39.946  |
| 12  | 39.622467  | 25  | 39.923  |
| 13  | 39.513515  |     |            |
  <div align="center"> Таблица 2. Экспериментальные данные, полученные для первой версии. Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

  | №   | Время в обычной версии с ключом -O0, с ± 10<sup>-6</sup>   | №   | Время в обычной версии с ключом -O0, с ± 10<sup>-6</sup>   |
|-----|-------------|-----|-------------|
| 1   | 39.875515   | 15  | 39.651   |
| 2   | 39.541359   | 16  | 39.600   |
| 3   | 39.528011   | 17  | 39.586   |
| 4   | 39.561279   | 18  | 39.549   |
| 5   | 39.501640   | 19  | 39.583   |
| 6   | 39.526173   | 20  | 39.816   |
| 7   | 39.534252   | 21  | 39.920   |
| 8   | 39.553780   | 22  | 39.572   |
| 9   | 39.586887   | 23  | 39.662   |
| 10  | 39.926250   | 24  | 39.665   |
| 11  | 39.645107   | 25  | 39.566   |
| 12  | 40.015049   | 26  | 39.579   |
| 13  | 39.580147   | 27  | 39.681   |
| 14  | 39.537243   |     |             |
  <div align="center"> Таблица 3. Экспериментальные данные, полученные для первой версии с ключом оптимизации -О0.  Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

| №   | Время в обычной версии с ключом -O3, с ± 10<sup>-6</sup>   | №   | Время в обычной версии с ключом -O3, с ± 10<sup>-6</sup>   |
|-----|-------------|-----|-------------|
| 1   | 20.129501   | 15  | 19.933   |
| 2   | 20.167023   | 16  | 19.938   |
| 3   | 20.144922   | 17  | 19.938   |
| 4   | 20.127441   | 18  | 19.929   |
| 5   | 19.934141   | 19  | 19.913   |
| 6   | 19.930944   | 20  | 19.926   |
| 7   | 19.921576   | 21  | 19.930   |
| 8   | 19.926151   | 22  | 19.932   |
| 9   | 19.924517   | 23  | 19.926   |
| 10  | 19.934677   | 24  | 19.939   |
| 11  | 20.086153   | 25  | 19.913   |
| 12  | 20.171812   | 26  | 19.921   |
| 13  | 20.156691   | 27  | 20.092   |
| 14  | 20.191521   |     |             |
 <div align="center"> Таблица 4. Экспериментальные данные, полученные для первой версии с ключом оптимизации -O3. Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

| №   | Версия, оптимизировання интринсиками, с ± 10<sup>-6</sup>  | №   |  Версия, оптимизировання интринсиками, с ± 10<sup>-6</sup>  |
|-----|-------------|-----|-------------|
| 1   | 23.971806   | 13  | 24.111   |
| 2   | 22.895058   | 14  | 24.154   |
| 3   | 23.211262   | 15  | 23.291   |
| 4   | 24.494003   | 16  | 24.241   |
| 5   | 24.201456   | 17  | 23.346   |
| 6   | 23.046597   | 18  | 24.422   |
| 7   | 24.715744   | 19  | 24.853   |
| 8   | 23.079561   | 20  | 23.955   |
| 9   | 23.339951   | 21  | 23.212   |
| 10  | 24.060940   | 22  | 23.666   |
| 11  | 24.193596   | 23  | 24.721   |
| 12  | 23.372887   | 24  | 24.741   |
<div align="center"> Таблица 5. Экспериментальные данные, полученные для версии, оптимизированной интринсиками. Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

| №   | Версия, оптимизированная интринсиками с ключом -O0, с ± 10<sup>-6</sup> | №   | Версия, оптимизированная интринсиками с ключом -O0, с ± 10<sup>-6</sup> |
|-----|---------------|-----|---------------|
| 1   | 22.952927     | 16  | 24.940     |
| 2   | 22.549068     | 17  | 23.444     |
| 3   | 22.982044     | 18  | 23.847     |
| 4   | 23.598991     | 19  | 23.819     |
| 5   | 24.377777     | 20  | 24.681     |
| 6   | 24.310888     | 21  | 24.901     |
| 7   | 24.468403     | 22  | 23.835     |
| 8   | 23.616400     | 23  | 24.897     |
| 9   | 23.327295     | 24  | 23.433     |
| 10  | 24.296551     | 25  | 23.767     |
| 11  | 23.171297     | 26  | 23.994     |
| 12  | 23.572229     | 27  | 24.954     |
| 13  | 24.082523     | 28  | 23.535     |
| 14  | 24.773478     | 29  | 24.032     |
| 15  | 23.281050     | 30  | 23.870     |
<div align="center"> Таблица 6. Экспериментальные данные, полученные для версии, оптимизированной интринсиками, с ключом оптимизации -О0.  Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

| №   | Версия, оптимизированная интринсиками с ключом -O3, с ± 10<sup>-6</sup> | №   | Версия, оптимизированная интринсиками с ключом -O3, с ± 10<sup>-6</sup> |
|-----|---------------|-----|---------------|
| 1   | 6.336559      | 16  | 6.315      |
| 2   | 6.394453      | 17  | 6.318      |
| 3   | 6.433603      | 18  | 6.331      |
| 4   | 6.348865      | 19  | 6.315      |
| 5   | 6.396700      | 20  | 6.323      |
| 6   | 6.319700      | 21  | 6.341      |
| 7   | 6.312135      | 22  | 6.330      |
| 8   | 6.315808      | 23  | 6.310      |
| 9   | 6.323038      | 24  | 6.330      |
| 10  | 6.326257      | 25  | 6.392      |
| 11  | 6.311866      | 26  | 6.381      |
| 12  | 6.320442      | 27  | 6.394      |
| 13  | 6.321612      | 28  | 6.385     |
| 14  | 6.323684      | 29  | 6.395      |
| 15  | 6.305323      | 30  | 6.407      |
<div align="center"> Таблица 7.  Экспериментальные данные, полученные для версии, оптимизированной интринсиками с ключом оптимизации -O3. Каждое измерение показывает время, затраченное на 120 итераций расчёта всех точек на экране для фрактала Мандельброта.</div><br>

Инструментальная погрешность класса time библиотеки SFML около 1 мс.

### Приложение В. Красивые места моей графики

  <img src="/img/BEAUTYPICTUREFIRST.png">
  <div align="center"> Рис. 5. Первое красивое место</div><br>

  <img src="/img/BEAUTYPICTURETHIRD.png">
  <div align="center"> Рис. 6. Второе красивое место</div><br>

  <img src="/img/BEAUTYPICTURESECOND.png">
  <div align="center"> Рис. 7. Третье красивое место</div><br>

  <img src="/img/PEAUTYPICTURE4TH.png">
  <div align="center"> Рис. 8. Четвёртое красивое место</div><br>
